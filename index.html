<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page_title">Pollos Don Juan - Panel de Control Av√≠cola</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- ESTILOS BASE (Futurista / Dark Mode) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a2e; /* Azul Oscuro Profundo */
            color: #e0f7fa; /* Cian Claro para el texto */
            transition: background-color 0.5s;
        }
        /* Efecto de Fondo (Simula una rejilla o circuito) */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 1px, #0f0f1b 1px, #0f0f1b 20px),
                              repeating-linear-gradient(90deg, transparent, transparent 1px, #0f0f1b 1px, #0f0f1b 20px);
            opacity: 0.3;
            z-index: -1;
        }
        header {
            text-align: center;
            padding: 20px;
            background-color: #162447; /* Azul Oscuro Medio */
            color: #4CAF50; /* Verde Ne√≥n */
            margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5); /* Resplandor Ne√≥n */
            border-bottom: 2px solid #4CAF50;
        }
        header h1 {
            text-shadow: 0 0 5px #4CAF50, 0 0 10px #4CAF50;
        }
        .container {
            max-width: 1000px;
            margin: auto;
            background: rgba(22, 36, 71, 0.7); /* Base semi-transparente */
            backdrop-filter: blur(5px); /* Efecto cristal */
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.3), 0 0 40px rgba(0, 188, 212, 0.1); /* Resplandor Cian */
            border: 1px solid rgba(0, 188, 212, 0.5);
            margin-bottom: 20px;
        }
        
        /* --- ESTILOS DEL MEN√ö/NAVEGACI√ìN (Tabs de Consola) --- */
        .navbar {
            display: flex;
            justify-content: flex-start;
            background-color: transparent;
            border-bottom: 2px solid #3f51b5; 
            margin-bottom: 30px;
            padding: 0 5px;
        }
        .nav-button {
            padding: 15px 20px;
            border: none;
            background: #162447;
            cursor: pointer;
            font-weight: bold;
            color: #e0f7fa;
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s;
            flex-grow: 0; 
            max-width: 25%;
            margin-right: 5px;
            border-radius: 6px 6px 0 0;
            border: 1px solid transparent;
            border-bottom: none;
        }
        .nav-button:hover {
            background-color: #2c3e50;
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        }
        .nav-button.active {
            color: #00bcd4; /* Cian Ne√≥n Activo */
            background-color: #1a1a2e;
            border: 1px solid #00bcd4;
            border-bottom: 1px solid #1a1a2e; 
            box-shadow: 0 -2px 10px rgba(0, 188, 212, 0.8);
        }
        .content-section {
            padding: 20px 0 0 0; 
        }

        /* --- Estilos de Componentes --- */
        h2 {
            color: #FFEB3B; /* Amarillo Ne√≥n para t√≠tulos */
            border-left: 5px solid #FFEB3B;
            padding-left: 10px;
            padding-bottom: 5px;
            margin-bottom: 25px;
            text-shadow: 0 0 3px rgba(255, 235, 59, 0.7);
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0f7fa;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #3f51b5;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #1a1a2e; 
            color: #e0f7fa;
            box-shadow: inset 0 0 5px rgba(63, 81, 181, 0.5);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #00bcd4;
            box-shadow: 0 0 8px rgba(0, 188, 212, 0.8);
            outline: none;
        }
        
        /* Estilos de Tabla */
        #galpones-config-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        #galpones-config-table th, #galpones-config-table td {
            border: 1px solid #3f51b5;
            padding: 10px;
            text-align: left;
            background-color: #162447;
        }
        #galpones-config-table th {
            background-color: #3f51b5;
            color: white;
        }
        #galpones-config-table td input {
            border: none;
            background: transparent;
            padding: 0;
            margin: 0;
            box-shadow: none;
            text-align: right;
            color: #FFEB3B; /* Texto de input en amarillo */
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap; 
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s, box-shadow 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        /* Botones con Resplandor Ne√≥n */
        #btn-calcular {
            background-color: #FFEB3B; /* Amarillo */
            color: #1a1a2e;
        }
        #btn-calcular:hover {
            box-shadow: 0 0 15px #FFEB3B;
        }
        #btn-guardar {
            background-color: #00bcd4; /* Cian */
            color: #1a1a2e;
            display: none;
        }
        #btn-guardar:hover {
            box-shadow: 0 0 15px #00bcd4;
        }
        #btn-config-galpones, #btn-registrar-mortalidad {
            background-color: #4CAF50; /* Verde Ne√≥n */
            color: #1a1a2e;
            width: 100%;
            margin-top: 10px;
        }
        #btn-config-galpones:hover, #btn-registrar-mortalidad:hover {
            background-color: #66BB6A;
            box-shadow: 0 0 15px #4CAF50;
        }
        #btn-reporte-completo {
            background-color: #3f51b5; /* Azul oscuro */
            color: white;
        }
        #btn-reporte-completo:hover {
            box-shadow: 0 0 15px #3f51b5;
        }
        #btn-guardar-mortalidad {
            background-color: #f44336 !important; /* Rojo */
            color: white !important;
        }
        #btn-guardar-mortalidad:hover {
            box-shadow: 0 0 15px #f44336;
        }
        #btn-balanceado-calcular {
            background-color: #FF9800;
            color: black;
        }
        #btn-balanceado-calcular:hover {
            box-shadow: 0 0 15px #FF9800;
        }

        /* RESULTADO BLOCKS */
        #resultados, #resultados_mortalidad {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(76, 175, 80, 0.1); /* Fondo Transparente Verde */
            border: 1px solid #4CAF50;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5); /* Resplandor de Estado */
        }
        #resultados h3, #resultados_mortalidad h3 {
            color: #FFEB3B; 
            border-left: 3px solid #FFEB3B;
            padding-left: 5px;
            margin-top: 0;
        }
        .resultado-item {
            padding: 5px 0;
            border-bottom: 1px dashed #3f51b5;
        }
        .resultado-item:last-child {
            border-bottom: none;
        }
        .resultado-item span {
            font-weight: bold;
            color: #00bcd4;
        }
        /* Estilos de Estado */
        #config-status {
            margin-top: 15px;
            font-weight: bold;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }
        .status-error {
            color: #f44336 !important;
            border: 1px solid #f44336;
            box-shadow: 0 0 8px rgba(244, 67, 54, 0.5);
        }
        .status-success {
            color: #4CAF50 !important;
            border: 1px solid #4CAF50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }

        /* --- Estilos para Dispositivos M√≥viles (Media Query) --- */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .navbar {
                flex-wrap: wrap; 
            }
            .nav-button {
                flex-grow: 1; 
                max-width: 50%;
                padding: 10px 5px;
                font-size: 0.8em;
                margin: 2px;
            }
            .btn-group {
                flex-direction: column; 
                gap: 10px;
            }
            button {
                width: 100% !important; 
            }
            #galpones-config-table tr {
                border: 1px solid #3f51b5;
            }
            #galpones-config-table td {
                background-color: #162447;
            }
            #galpones-config-table td::before {
                color: #00bcd4;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1 id="farm_title">ü§ñ Granja Av√≠cola Pollos Don Juan - CONSOLE üìä</h1>
        <p>Sistema de Monitoreo y An√°lisis de Producci√≥n</p>
    </header>

    <div class="navbar container">
        <button class="nav-button active" onclick="showSection('config-section', this)">üõ†Ô∏è Configuraci√≥n</button>
        <button class="nav-button" onclick="showSection('peso-section', this)">üìà Peso Semanal</button>
        <button class="nav-button" onclick="showSection('mortalidad-section', this)">üö® Mortalidad</button>
        <button class="nav-button" onclick="showSection('balanceado-section', this)">üîã Consumo Balanceado</button>
        <button class="nav-button" onclick="showSection('reporte-section', this)">üåê Reporte Global</button>
    </div>
    
    <div class="container">
        <div id="config-section" class="content-section active">
            <h2>> ACCESO 01: Par√°metros de Lote e Infraestructura</h2>
            <p><strong style="color: #4CAF50;">[STATUS: ONLINE]</strong> El sistema cargar√° y guardar√° los datos en tu navegador.</p>

            <div class="input-group">
                <label for="farm_name">Nombre de la Granja / M√≥dulo:</label>
                <input type="text" id="farm_name" value="Granja Av√≠cola Pollos Don Juan" required>
            </div>
            
            <div class="input-group">
                <label for="num_galpones">Cantidad de Unidades (Galpones) en la Granja:</label>
                <input type="number" id="num_galpones" min="1" value="1" required oninput="generarCamposGalpones()">
            </div>

            <div id="campos-galpones-container">
                <table id="galpones-config-table">
                    <thead>
                        <tr>
                            <th>Unidad (ID)</th>
                            <th>Capacidad Inicial (Aves)</th>
                        </tr>
                    </thead>
                    <tbody id="galpones-tbody">
                        <tr>
                            <td data-label="Galp√≥n (ID)">Galp√≥n 1 (G1)</td>
                            <td data-label="Aves Iniciales"><input type="number" min="1" class="input-aves" id="aves_G1" placeholder="Ej: 20000" required></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="btn-group" style="flex-direction: column; gap: 10px;">
                <button id="btn-config-galpones" onclick="guardarConfiguracion()">ACTIVAR & GUARDAR PAR√ÅMETROS</button>
            </div>

            <div id="config-status" class="status-error" style="margin-top: 10px;">‚ö†Ô∏è INGRESO REQUERIDO: Configuraci√≥n pendiente.</div>
        </div>

        <div id="peso-section" class="content-section">
            <h2>> ACCESO 02: Monitoreo de Crecimiento (Peso)</h2>
            <p>Registro de datos de pesaje y contraste con m√©tricas est√°ndar.</p>
            
            <div class="input-group">
                <label for="galpon">Seleccionar Unidad (Galp√≥n):</label>
                <select id="galpon" disabled>
                    <option value="" disabled selected>Primero configure los galpones (Secci√≥n 1)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="semana">Semana de Vida (Ciclo Av√≠cola):</label>
                <select id="semana">
                    <option value="1">Semana 1 (7 D√≠as)</option>
                    <option value="2">Semana 2 (14 D√≠as)</option>
                    <option value="3">Semana 3 (21 D√≠as)</option>
                    <option value="4">Semana 4 (28 D√≠as)</option>
                    <option value="5">Semana 5 (35 D√≠as)</option>
                    <option value="6">Semana 6 (42 D√≠as)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="aves_pesadas">N¬∞ de Aves Pesadas (Muestra):</label>
                <input type="number" id="aves_pesadas" min="1" required placeholder="Ej: 100">
            </div>

            <div class="input-group">
                <label for="peso_total">Peso Total de la Muestra (en gramos):</label>
                <input type="number" id="peso_total" min="1" required placeholder="Ej: 155000">
            </div>

            <div class="btn-group">
                <button id="btn-calcular" onclick="calcularCrecimiento()">EJECUTAR C√ÅLCULO DE PESO</button>
                <button id="btn-guardar" onclick="generarPDFPeso()">üì• GENERAR REPORTE PDF (PESO)</button>
            </div>

            <div id="resultados" style="display: none;">
                <h3>[OUTPUT] An√°lisis de Crecimiento</h3>
                <div class="resultado-item">Unidad Seleccionada: <span id="res_galpon"></span></div>
                <div class="resultado-item">Inventario Actual: <span id="res_aves_actuales"></span> aves</div>
                <div class="resultado-item">Semana de Ciclo: <span id="res_semana"></span></div>
                <hr>
                <div class="resultado-item">Peso Promedio Real (Gramos): <span id="promedio_real"></span></div>
                <div class="resultado-item">Diferencia con Est√°ndar (Gramos): <span id="diferencia_gramos"></span></div>
                <div class="resultado-item">
                    <p><strong>Desempe√±o vs. Est√°ndar:</strong> <span id="porcentaje_subida"></span></p>
                </div>
            </div>
        </div>

        <div id="mortalidad-section" class="content-section">
            <h2>> ACCESO 03: Registro de P√©rdidas y Mortalidad</h2>
            <p>Monitoreo de bajas para actualizar el inventario y m√©tricas de riesgo.</p>

            <div class="input-group">
                <label for="galpon_mortalidad">Seleccionar Unidad (Galp√≥n):</label>
                <select id="galpon_mortalidad" disabled>
                    <option value="" disabled selected>Primero configure los galpones (Secci√≥n 1)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="semana_mortalidad">Semana de Ciclo (Registro de P√©rdida):</label>
                <select id="semana_mortalidad">
                    <option value="1">Semana 1</option>
                    <option value="2">Semana 2</option>
                    <option value="3">Semana 3</option>
                    <option value="4">Semana 4</option>
                    <option value="5">Semana 5</option>
                    <option value="6">Semana 6</option>
                </select>
            </div>

            <div class="input-group">
                <label for="mortalidad_semanal">Aves Muertas en la Semana (Unidades):</label>
                <input type="number" id="mortalidad_semanal" min="0" value="0" required placeholder="Ej: 50">
            </div>

            <div class="btn-group">
                <button id="btn-registrar-mortalidad" onclick="registrarMortalidad()">REGISTRAR P√âRDIDAS & ACTUALIZAR INVENTARIO</button>
                <button id="btn-guardar-mortalidad" onclick="generarPDFMortalidad()" style="display: none;">üì• GENERAR REPORTE PDF (MORTALIDAD)</button>
            </div>

            <div id="resultados_mortalidad" style="display: none;">
                <h3>[OUTPUT] An√°lisis de Riesgo (Mortalidad)</h3>
                <div class="resultado-item">Unidad: <span id="res_mort_galpon"></span></div>
                <div class="resultado-item">Aves al Inicio de Lote: <span id="res_mort_inicial"></span></div>
                <hr>
                <div class="resultado-item">P√©rdidas Semanales: <span id="res_mort_semana_num"></span></div>
                <div class="resultado-item">Mortalidad Semanal: <span id="res_mort_porc_semanal" style="color: #f44336;"></span></div>
                <div class="resultado-item">Mortalidad Acumulada (Total): <span id="res_mort_porc_acumulado" style="color: #f44336;"></span></div>
                <hr>
                <div class="resultado-item"><strong>INVENTARIO VIVO ACTUAL:</strong> <span id="res_mort_actual" style="color: #4CAF50;"></span> unidades</div>
            </div>
        </div>

        <div id="balanceado-section" class="content-section">
            <h2>> ACCESO 04: Log√≠stica de Alimentaci√≥n (Balanceado)</h2>
            <p>Registro de consumo de alimento para c√°lculo de FCR (Conversi√≥n Alimenticia).</p>
            
            <div class="input-group">
                <label for="galpon_balanceado">Seleccionar Unidad (Galp√≥n):</label>
                <select id="galpon_balanceado" disabled>
                    <option value="" disabled selected>Primero configure los galpones (Secci√≥n 1)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="consumo_semanal">Consumo Total de la Semana (en kg):</label>
                <input type="number" id="consumo_semanal" min="0" required placeholder="Ej: 5000">
            </div>
            
            <div class="btn-group">
                <button id="btn-balanceado-calcular" style="background-color: #FF9800; color: black;">CALCULAR FCR (M√âTRICA PENDIENTE)</button> 
            </div>
            <p style="color: #FFEB3B; margin-top: 20px;">[NOTA]: La funcionalidad de FCR est√° pendiente de desarrollo en esta versi√≥n de la consola.</p>
        </div>

        <div id="reporte-section" class="content-section">
            <h2>> ACCESO 05: Reporte Global y Estad√≠sticas</h2>
            <p>Generaci√≥n de un reporte resumido del estado actual de toda la operaci√≥n.</p>
            <div class="btn-group" style="flex-direction: column; gap: 10px;">
                <button id="btn-reporte-completo" onclick="generarReporteCompletoPDF()">üåê GENERAR REPORTE COMPLETO (PDF) </button>
            </div>
        </div>

    </div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // TABLA EST√ÅNDAR DE PESOS DE POLLOS DON JUAN (en gramos)
        const tablaEstandar = {
            1: 170, 2: 450, 3: 900, 4: 1550, 5: 2300, 6: 3050
        };

        // Variables globales de datos
        let farmName = "Granja Av√≠cola Pollos Don Juan"; 
        let galponesData = {}; 
        let datosCalculadosPeso = {};
        let datosCalculadosMortalidad = {};

        // --- FUNCIONES DE MEN√ö ---
        function showSection(sectionId, element) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
        }

        // --- FUNCIONES DE ALMACENAMIENTO ---

        function guardarDatosEnLocalStorage() {
            localStorage.setItem('farmName', farmName);
            localStorage.setItem('galponesData', JSON.stringify(galponesData));
        }

        function actualizarSelectoresGalpones() {
            const selectores = [
                document.getElementById('galpon'),
                document.getElementById('galpon_mortalidad'),
                document.getElementById('galpon_balanceado') 
            ];
            
            selectores.forEach(select => {
                select.innerHTML = ''; 
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Seleccione una unidad";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                for (const galponID in galponesData) {
                    const avesActuales = galponesData[galponID].current.toLocaleString();
                    const option = document.createElement('option');
                    option.value = galponID;
                    option.textContent = `${galponID} (Inventario: ${avesActuales} aves)`;
                    select.appendChild(option);
                }
                select.disabled = false;
            });
        }
        
        function cargarDatos() {
            const savedFarmName = localStorage.getItem('farmName');
            const savedGalponesData = localStorage.getItem('galponesData');

            if (savedFarmName) {
                farmName = savedFarmName;
                document.getElementById('farm_title').innerHTML = `ü§ñ ${farmName} - CONSOLE üìä`;
                document.getElementById('page_title').textContent = `${farmName} - Panel de Control Av√≠cola`;
                document.getElementById('farm_name').value = farmName;
            }

            if (savedGalponesData) {
                galponesData = JSON.parse(savedGalponesData);
                
                const numGalpones = Object.keys(galponesData).length;
                document.getElementById('num_galpones').value = numGalpones;

                const tbody = document.getElementById('galpones-tbody');
                tbody.innerHTML = '';
                let totalAves = 0;

                for (const galponID in galponesData) {
                    const i = galponID.replace('G', '');
                    const initialAves = galponesData[galponID].initial;
                    const row = `
                        <tr>
                            <td data-label="Unidad (ID)">Galp√≥n ${i} (${galponID})</td>
                            <td data-label="Capacidad Inicial"><input type="number" min="1" class="input-aves" id="aves_${galponID}" placeholder="Ej: 20000" value="${initialAves}" required></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                    totalAves += initialAves;
                }

                const statusElement = document.getElementById('config-status');
                statusElement.textContent = `‚úÖ [STATUS: OK] Configuraci√≥n cargada. ${numGalpones} unidades configuradas. Total inicial: ${totalAves.toLocaleString()} aves.`;
                statusElement.classList.remove('status-error');
                statusElement.classList.add('status-success');
                
                actualizarSelectoresGalpones(); 
                
            } else {
                generarCamposGalpones();
            }
        }

        document.addEventListener('DOMContentLoaded', cargarDatos);


        // --- FUNCIONES DE INTERFAZ Y L√ìGICA ---

        function generarCamposGalpones() {
            const numGalpones = parseInt(document.getElementById('num_galpones').value);
            const tbody = document.getElementById('galpones-tbody');
            tbody.innerHTML = '';
            
            if (numGalpones < 1 || isNaN(numGalpones)) {
                tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">ERROR: Ingrese un n√∫mero v√°lido de galpones.</td></tr>';
                return;
            }

            for (let i = 1; i <= numGalpones; i++) {
                const galponID = `G${i}`;
                const row = `
                    <tr>
                        <td data-label="Unidad (ID)">Galp√≥n ${i} (${galponID})</td>
                        <td data-label="Capacidad Inicial"><input type="number" min="1" class="input-aves" id="aves_${galponID}" placeholder="Ej: 20000" required></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        }

        function guardarConfiguracion() {
            const newFarmName = document.getElementById('farm_name').value.trim();
            const statusElement = document.getElementById('config-status');

            if (!newFarmName) {
                alert('Debe ingresar un nombre para la Granja.');
                return;
            }
            farmName = newFarmName;
            document.getElementById('farm_title').innerHTML = `ü§ñ ${farmName} - CONSOLE üìä`;
            document.getElementById('page_title').textContent = `${farmName} - Panel de Control Av√≠cola`;


            const inputsAves = document.querySelectorAll('.input-aves');
            let tempGalponesData = {}; 
            let todoValido = true;
            let totalAves = 0;

            inputsAves.forEach(input => {
                const galponID = input.id.replace('aves_', '');
                const cantidadAves = parseInt(input.value);

                if (isNaN(cantidadAves) || cantidadAves <= 0) {
                    todoValido = false;
                    return;
                }
                
                const existingData = galponesData[galponID] || {
                    initial: 0,
                    current: 0,
                    mortalidadAcumulada: 0,
                    mortalidadHistory: {} 
                };

                if (existingData.initial !== cantidadAves) {
                    tempGalponesData[galponID] = {
                        initial: cantidadAves,
                        current: cantidadAves,
                        mortalidadAcumulada: 0,
                        mortalidadHistory: {}
                    };
                } else {
                    tempGalponesData[galponID] = existingData;
                }
                totalAves += tempGalponesData[galponID].initial;
            });

            if (!todoValido) {
                statusElement.textContent = '‚ö†Ô∏è ¬°Error! Ingrese una cantidad de aves v√°lida y mayor a cero para todos los galpones.';
                statusElement.classList.remove('status-success');
                statusElement.classList.add('status-error');
                return;
            }

            galponesData = tempGalponesData; 
            guardarDatosEnLocalStorage(); 
            actualizarSelectoresGalpones(); 

            statusElement.textContent = `‚úÖ [STATUS: OK] Configuraci√≥n guardada. ${Object.keys(galponesData).length} unidades configuradas. Total inicial: ${totalAves.toLocaleString()} aves.`;
            statusElement.classList.remove('status-error');
            statusElement.classList.add('status-success');
        }

        function registrarMortalidad() {
            const galpon = document.getElementById('galpon_mortalidad').value;
            const semana = parseInt(document.getElementById('semana_mortalidad').value);
            const mortalidad = parseInt(document.getElementById('mortalidad_semanal').value);

            if (!galpon || galponesData[galpon] === undefined) {
                alert('Debe seleccionar y guardar la configuraci√≥n de una unidad (galp√≥n).');
                return;
            }
            if (isNaN(mortalidad) || mortalidad < 0) {
                alert('La cantidad de aves muertas debe ser un n√∫mero positivo.');
                return;
            }
            
            const data = galponesData[galpon];
            
            // Revertir el registro de la semana si existe, para recalcular
            const mortalidadPrevia = data.mortalidadHistory[semana] || 0;
            data.current += mortalidadPrevia;
            data.mortalidadAcumulada -= mortalidadPrevia;

            const avesAlInicioDeSemana = data.current; 
            if (mortalidad > avesAlInicioDeSemana) {
                alert('ERROR DE SISTEMA: La mortalidad registrada excede la cantidad de aves vivas actuales.');
                // Restaurar datos
                data.current -= mortalidadPrevia;
                data.mortalidadAcumulada += mortalidadPrevia;
                return;
            }

            data.current -= mortalidad;
            data.mortalidadAcumulada += mortalidad;
            data.mortalidadHistory[semana] = mortalidad;
            
            const mortSemanalPorc = (mortalidad / avesAlInicioDeSemana) * 100;
            const mortAcumuladaPorc = (data.mortalidadAcumulada / data.initial) * 100;

            // Almacenar para PDF
            datosCalculadosMortalidad = {
                galpon,
                semana,
                inicial: data.initial.toLocaleString(),
                muertasSemana: mortalidad.toLocaleString(),
                muertasAcumuladas: data.mortalidadAcumulada.toLocaleString(),
                actual: data.current.toLocaleString(),
                mortSemanal: mortSemanalPorc.toFixed(2),
                mortAcumulada: mortAcumuladaPorc.toFixed(2)
            };

            guardarDatosEnLocalStorage();
            actualizarSelectoresGalpones(); 
            
            document.getElementById('res_mort_galpon').textContent = galpon;
            document.getElementById('res_mort_inicial').textContent = datosCalculadosMortalidad.inicial;
            document.getElementById('res_mort_semana_num').textContent = datosCalculadosMortalidad.muertasSemana;
            document.getElementById('res_mort_porc_semanal').textContent = datosCalculadosMortalidad.mortSemanal + '%';
            document.getElementById('res_mort_porc_acumulado').textContent = datosCalculadosMortalidad.mortAcumulada + '%';
            document.getElementById('res_mort_actual').textContent = datosCalculadosMortalidad.actual;
            document.getElementById('resultados_mortalidad').style.display = 'block';
            document.getElementById('btn-guardar-mortalidad').style.display = 'inline-block';
        }

        function calcularCrecimiento() {
            const galpon = document.getElementById('galpon').value;
            const semana = parseInt(document.getElementById('semana').value);
            const avesPesadas = parseFloat(document.getElementById('aves_pesadas').value);
            const pesoTotal = parseFloat(document.getElementById('peso_total').value);

            if (!galpon || galponesData[galpon] === undefined) {
                alert('Debe seleccionar y guardar la configuraci√≥n de una unidad (galp√≥n).');
                return;
            }
            if (isNaN(avesPesadas) || avesPesadas <= 0 || isNaN(pesoTotal) || pesoTotal <= 0) {
                alert('ERROR: Ingrese valores v√°lidos y mayores a cero en los campos de pesaje.');
                return;
            }
            
            const data = galponesData[galpon];
            const pesoPromedioReal = pesoTotal / avesPesadas;
            const pesoEstandar = tablaEstandar[semana];

            if (!pesoEstandar) {
                alert('ADVERTENCIA: No hay un peso est√°ndar definido para esta semana.');
                return;
            }

            const diferenciaGramos = pesoPromedioReal - pesoEstandar;
            const porcentajeSubida = (diferenciaGramos / pesoEstandar) * 100;

            // Almacenar resultados para PDF
            datosCalculadosPeso = {
                galpon,
                avesActuales: data.current.toLocaleString(),
                semana: semana,
                promedioReal: pesoPromedioReal.toFixed(2),
                estandar: pesoEstandar.toFixed(2),
                diferencia: diferenciaGramos.toFixed(2),
                porcentaje: porcentajeSubida.toFixed(2)
            };
            
            document.getElementById('res_galpon').textContent = galpon;
            document.getElementById('res_aves_actuales').textContent = datosCalculadosPeso.avesActuales;
            document.getElementById('res_semana').textContent = datosCalculadosPeso.semana;
            document.getElementById('promedio_real').textContent = datosCalculadosPeso.promedioReal;
            document.getElementById('diferencia_gramos').textContent = datosCalculadosPeso.diferencia;
            
            const porcentajeElement = document.getElementById('porcentaje_subida');
            porcentajeElement.textContent = datosCalculadosPeso.porcentaje + '%';

            if (porcentajeSubida >= 0) {
                porcentajeElement.style.color = '#4CAF50'; // Verde Ne√≥n
                porcentajeElement.textContent = '‚Üë +' + porcentajeElement.textContent;
            } else {
                porcentajeElement.style.color = '#f44336'; // Rojo de Riesgo
                porcentajeElement.textContent = '‚Üì ' + porcentajeElement.textContent;
            }

            document.getElementById('resultados').style.display = 'block';
            document.getElementById('btn-guardar').style.display = 'inline-block';
        }

        // --- FUNCIONES DE GENERACI√ìN DE PDF (MODELO EXCEL/TABLA) ---

        // 5. L√≥gica para Generar PDF de Peso (USANDO AUTO TABLE)
        function generarPDFPeso() {
            if (Object.keys(datosCalculadosPeso).length === 0) {
                alert('Primero debe realizar un c√°lculo de peso.');
                return;
            }

            const data = datosCalculadosPeso;
            const doc = new jsPDF();
            const margen = 15;
            let linea = 15;

            doc.setFontSize(16);
            doc.text(`[REPORTE] AN√ÅLISIS DE CRECIMIENTO - ${farmName}`, margen, linea);
            linea += 7;
            doc.setFontSize(10);
            doc.text(`Fecha de Ejecuci√≥n: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margen, linea);
            linea += 10;
            
            // Tabla 1: Datos de Lote
            const head = [['M√©trica', 'Unidad (Galp√≥n)', 'Semana de Ciclo', 'Aves Vivas']];
            const body = [
                ['DATOS DE LOTE', data.galpon, data.semana, data.avesActuales]
            ];
            
            doc.autoTable({
                startY: linea,
                head: head,
                body: body,
                theme: 'grid',
                styles: { fontSize: 10, fillColor: [22, 36, 71], textColor: [255, 255, 255] },
                headStyles: { fillColor: [63, 81, 181] } // Azul Oscuro
            });
            linea = doc.autoTable.previous.finalY + 10;
            
            // Tabla 2: Resultados de Pesaje
            const headResultados = [['M√©trica de Peso', 'Valor (gramos)', 'Diferencia', 'Desempe√±o vs. Est√°ndar']];
            const bodyResultados = [
                ['Peso Promedio Real', data.promedioReal, data.diferencia, data.porcentaje + '%'],
                ['Peso Est√°ndar Don Juan', data.estandar, 'N/A', '']
            ];

            doc.autoTable({
                startY: linea,
                head: headResultados,
                body: bodyResultados,
                theme: 'striped',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [255, 235, 59], textColor: [0, 0, 0] }, // Amarillo Ne√≥n
                columnStyles: {
                    2: { fontStyle: 'bold', textColor: data.diferencia >= 0 ? [0, 128, 0] : [255, 0, 0] }, 
                    3: { fontStyle: 'bold', textColor: data.porcentaje >= 0 ? [0, 128, 0] : [255, 0, 0] } 
                }
            });

            const nombreArchivo = `RPT_CRECIMIENTO_${data.galpon}_S${data.semana}.pdf`;
            doc.save(nombreArchivo);
        }

        // 6. L√≥gica para Generar PDF de Mortalidad (USANDO AUTO TABLE)
        function generarPDFMortalidad() {
            if (Object.keys(datosCalculadosMortalidad).length === 0) {
                alert('Primero debe registrar la mortalidad.');
                return;
            }

            const data = datosCalculadosMortalidad;
            const doc = new jsPDF();
            const margen = 15;
            let linea = 15;

            doc.setFontSize(16);
            doc.text(`[REPORTE] AN√ÅLISIS DE RIESGO Y P√âRDIDAS - ${farmName}`, margen, linea); 
            linea += 7;
            doc.setFontSize(10);
            doc.text(`Fecha de Ejecuci√≥n: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margen, linea);
            linea += 10;

            // Tabla 1: Datos de Lote
            const headLote = [['Unidad (Galp√≥n)', 'Semana Registrada', 'Aves Iniciales']];
            const bodyLote = [
                [data.galpon, data.semana, data.inicial]
            ];

            doc.autoTable({
                startY: linea,
                head: headLote,
                body: bodyLote,
                theme: 'grid',
                styles: { fontSize: 10, fillColor: [22, 36, 71], textColor: [255, 255, 255] },
                headStyles: { fillColor: [244, 67, 54] } // Rojo de Riesgo
            });
            linea = doc.autoTable.previous.finalY + 10;

            // Tabla 2: Resultados
            const headResultados = [['M√©trica de Riesgo', 'Cantidad (Unidades)', 'Tasa (%)']];
            const bodyResultadosFinal = [
                ['P√âRDIDAS SEMANAL', data.muertasSemana, {content: data.mortSemanal + '%', styles: {textColor: [255, 0, 0]}}],
                ['P√âRDIDAS ACUMULADAS (TOTAL)', data.muertasAcumuladas, {content: data.mortAcumulada + '%', styles: {textColor: [255, 0, 0]}}],
                [{content: 'INVENTARIO VIVO ACTUAL', colSpan: 2, styles: {fillColor: [76, 175, 80], fontStyle: 'bold', textColor: [0, 0, 0]}}, {content: data.actual, styles: {fillColor: [76, 175, 80], fontStyle: 'bold', textColor: [0, 0, 0]}}]
            ];

            doc.autoTable({
                startY: linea,
                head: headResultados,
                body: bodyResultadosFinal,
                theme: 'striped',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [248, 249, 250], textColor: [0, 0, 0] },
            });

            const nombreArchivo = `RPT_MORTALIDAD_${data.galpon}_S${data.semana}.pdf`;
            doc.save(nombreArchivo);
        }

        // 7. Funci√≥n para generar el Reporte COMPLETO de la Granja (USANDO AUTO TABLE)
        function generarReporteCompletoPDF() {
            if (Object.keys(galponesData).length === 0) {
                alert('ERROR: Primero debe configurar y guardar la informaci√≥n de al menos una unidad (galp√≥n).');
                return;
            }

            const doc = new jsPDF();
            const margen = 15;
            let linea = 15;

            // --- ENCABEZADO PRINCIPAL ---
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(`[REPORTE GLOBAL] ESTADO DEL SISTEMA - ${farmName}`, margen, linea);
            linea += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Fecha de Generaci√≥n: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margen, linea);
            linea += 10;

            // --- RESUMEN POR GALP√ìN ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('ESTADO DE INVENTARIO Y P√âRDIDAS POR UNIDAD:', margen, linea);
            
            const headGalpones = [
                ['Unidad (ID)', 'Aves Iniciales', 'Mortalidad Acum.', 'Tasa % (Riesgo)', 'Aves Vivas Actuales']
            ];
            
            const bodyGalpones = [];
            let totalAvesVivas = 0;

            for (const galponID in galponesData) {
                const data = galponesData[galponID];
                const mortPorc = (data.mortalidadAcumulada / data.initial) * 100;
                totalAvesVivas += data.current;
                
                const historiaMort = Object.entries(data.mortalidadHistory)
                                            .map(([semana, muertas]) => `S${semana}: ${muertas.toLocaleString()}`)
                                            .join(' | ');

                bodyGalpones.push([
                    galponID,
                    data.initial.toLocaleString(),
                    data.mortalidadAcumulada.toLocaleString(),
                    {content: `${mortPorc.toFixed(2)}%`, styles: {textColor: [255, 0, 0]}},
                    {content: data.current.toLocaleString(), styles: {fontStyle: 'bold', textColor: [0, 128, 0]}} 
                ]);
                
                bodyGalpones.push([
                    { content: `Historial Semanal: ${historiaMort || '(No hay registros)'}`, colSpan: 5, styles: { fontStyle: 'italic', fontSize: 8, fillColor: [240, 240, 240] } }
                ]);
            }
            
            // Fila de total
            bodyGalpones.push([
                {content: 'TOTAL VIVO EN GRANJA', colSpan: 4, styles: {fontStyle: 'bold', fillColor: [189, 189, 189], halign: 'right'}},
                {content: totalAvesVivas.toLocaleString(), styles: {fontStyle: 'bold', textColor: [0, 128, 0], fillColor: [189, 189, 189]}}
            ]);


            doc.autoTable({
                startY: linea + 5,
                head: headGalpones,
                body: bodyGalpones,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [56, 142, 60], textColor: [255, 255, 255] } // Verde Av√≠cola
            });
            linea = doc.autoTable.previous.finalY + 10;

            // --- RESUMEN DE √öLTIMOS C√ÅLCULOS ESPEC√çFICOS ---
            if (linea > 260) {
                doc.addPage();
                linea = 15;
            }

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN DE √öLTIMOS REGISTROS:', margen, linea);
            
            const headCalculos = [
                ['Tipo de Reporte', 'Unidad', 'Semana', 'M√©trica 1', 'M√©trica 2']
            ];
            const bodyCalculos = [];

            if (Object.keys(datosCalculadosPeso).length > 0) {
                bodyCalculos.push([
                    {content: 'PESO (CRECIMIENTO)', styles: {fontStyle: 'bold'}},
                    datosCalculadosPeso.galpon,
                    datosCalculadosPeso.semana,
                    `P. Real: ${datosCalculadosPeso.promedioReal}g`,
                    `vs. Est√°ndar: ${datosCalculadosPeso.porcentaje}%`
                ]);
            } else {
                bodyCalculos.push([
                    {content: 'PESO (CRECIMIENTO)', styles: {fontStyle: 'bold'}},
                    {content: 'No hay c√°lculo de peso reciente registrado.', colSpan: 4, styles: {fontStyle: 'italic'}}
                ]);
            }

            if (Object.keys(datosCalculadosMortalidad).length > 0) {
                bodyCalculos.push([
                    {content: 'MORTALIDAD (RIESGO)', styles: {fontStyle: 'bold'}},
                    datosCalculadosMortalidad.galpon,
                    datosCalculadosMortalidad.semana,
                    `Semanal: ${datosCalculadosMortalidad.mortSemanal}%`,
                    `Acumulada: ${datosCalculadosMortalidad.mortAcumulada}%`
                ]);
            } else {
                bodyCalculos.push([
                    {content: 'MORTALIDAD (RIESGO)', styles: {fontStyle: 'bold'}},
                    {content: 'No hay registro de mortalidad reciente guardado.', colSpan: 4, styles: {fontStyle: 'italic'}}
                ]);
            }

            doc.autoTable({
                startY: linea + 5,
                head: headCalculos,
                body: bodyCalculos,
                theme: 'striped',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [150, 150, 150] }
            });

            const nombreArchivo = `RPT_GLOBAL_${farmName.replace(/ /g, '_')}_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`;
            doc.save(nombreArchivo);
        }
    </script>

</body>
</html>
