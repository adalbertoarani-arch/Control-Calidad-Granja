<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page_title">Pollos Don Juan - Control de Producci√≥n</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* --- ESTILOS BASE --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        header {
            text-align: center;
            padding: 10px;
            background-color: #388e3c; /* Verde Av√≠cola */
            color: white;
            margin-bottom: 20px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* --- ESTILOS DEL MEN√ö/NAVEGACI√ìN --- */
        .navbar {
            display: flex;
            justify-content: center;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        .nav-button {
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: bold;
            color: #495057;
            transition: background-color 0.3s, color 0.3s;
            flex-grow: 1; 
            max-width: 25%;
        }
        .nav-button:hover {
            background-color: #e9ecef;
        }
        .nav-button.active {
            color: #1e88e5; 
            border-bottom: 3px solid #1e88e5;
            background-color: white;
        }
        .content-section {
            display: none; 
            padding: 0 20px 20px 20px;
        }
        .content-section.active {
            display: block;
        }
        /* --- Estilos de Componentes --- */
        h2 {
            color: #1e88e5; 
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #galpones-config-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        #galpones-config-table th, #galpones-config-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #galpones-config-table th {
            background-color: #f2f2f2;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap; 
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btn-calcular {
            background-color: #fbc02d;
            color: #333;
        }
        #btn-guardar {
            background-color: #007bff;
            color: white;
            display: none;
        }
        #btn-config-galpones, #btn-registrar-mortalidad {
            background-color: #5cb85c;
            color: white;
            width: 100%;
            margin-top: 10px;
        }
        #btn-reporte-completo {
            background-color: #3f51b5;
            color: white;
        }
        #btn-config-galpones:hover, #btn-registrar-mortalidad:hover {
            background-color: #4cae4c;
        }
        #resultados, #resultados_mortalidad {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 4px;
        }
        .resultado-item span {
            font-weight: bold;
        }

        /* --- Estilos para Dispositivos M√≥viles (Media Query) --- */
        @media (max-width: 600px) {
            .navbar {
                flex-wrap: wrap; 
            }
            .nav-button {
                flex-grow: 1; 
                max-width: 50%;
                padding: 10px 5px;
                font-size: 0.9em;
            }
            .content {
                padding: 10px;
            }
            .btn-group {
                flex-direction: column; 
                gap: 8px;
            }
            button, .input-group input, .input-group select {
                width: 100% !important; 
                box-sizing: border-box;
            }
            #galpones-config-table, #galpones-config-table thead, #galpones-config-table tbody, #galpones-config-table th, #galpones-config-table td, #galpones-config-table tr {
                display: block; 
                width: 100%;
            }
            #galpones-config-table tr {
                margin-bottom: 10px;
                border: 1px solid #ccc;
            }
            #galpones-config-table td {
                text-align: right;
                padding-left: 50%;
                position: relative;
            }
            #galpones-config-table td::before {
                content: attr(data-label); 
                position: absolute;
                left: 0;
                width: 50%;
                padding-left: 10px;
                font-weight: bold;
                text-align: left;
            }
            #galpones-config-table input {
                margin-bottom: 0; 
                border: none;
                padding: 0;
                text-align: right;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1 id="farm_title">üêî Granja Av√≠cola Pollos Don Juan üìä</h1>
        <p>Control de Producci√≥n, Crecimiento y Mortalidad</p>
    </header>

    <div class="navbar container">
        <button class="nav-button active" onclick="showSection('config-section', this)">‚öôÔ∏è Configuraci√≥n</button>
        <button class="nav-button" onclick="showSection('peso-section', this)">‚öñÔ∏è Peso Semanal</button>
        <button class="nav-button" onclick="showSection('mortalidad-section', this)">üíÄ Mortalidad</button>
        <button class="nav-button" onclick="showSection('balanceado-section', this)">üçö Consumo Balanceado</button>
        <button class="nav-button" onclick="showSection('reporte-section', this)">üìã Reporte</button>
    </div>
    
    <div class="container">
        <div id="config-section" class="content-section active">
            <h2>1. Configuraci√≥n Inicial de Lotes y Granja</h2>
            <p><strong style="color: red;">‚ö†Ô∏è Los datos se guardar√°n autom√°ticamente en tu navegador.</strong></p>

            <div class="input-group">
                <label for="farm_name">Nombre de la Granja:</label>
                <input type="text" id="farm_name" value="Granja Av√≠cola Pollos Don Juan" required>
            </div>
            
            <div class="input-group">
                <label for="num_galpones">Cantidad de Galpones en la Granja:</label>
                <input type="number" id="num_galpones" min="1" value="1" required oninput="generarCamposGalpones()">
            </div>

            <div id="campos-galpones-container">
                <table id="galpones-config-table">
                    <thead>
                        <tr>
                            <th>Galp√≥n (ID)</th>
                            <th>Cantidad Inicial de Aves</th>
                        </tr>
                    </thead>
                    <tbody id="galpones-tbody">
                        <tr>
                            <td data-label="Galp√≥n (ID)">Galp√≥n 1 (G1)</td>
                            <td data-label="Aves Iniciales"><input type="number" min="1" class="input-aves" id="aves_G1" placeholder="Ej: 20000" required></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="btn-group" style="flex-direction: column; gap: 10px;">
                <button id="btn-config-galpones" onclick="guardarConfiguracion()">Guardar Configuraci√≥n de Lotes</button>
            </div>

            <p id="config-status" style="margin-top: 10px; color: red; font-weight: bold;">‚ö†Ô∏è Ingrese y guarde la configuraci√≥n para comenzar.</p>
        </div>

        <div id="peso-section" class="content-section">
            <h2>2. Control de Peso Semanal</h2>
            <p>Seleccione el galp√≥n configurado y registre los datos de pesaje para el control de crecimiento.</p>
            
            <div class="input-group">
                <label for="galpon">Seleccionar Galp√≥n:</label>
                <select id="galpon" disabled>
                    <option value="" disabled selected>Primero configure los galpones (Secci√≥n 1)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="semana">Semana de Vida:</label>
                <select id="semana">
                    <option value="1">Semana 1 (7 D√≠as)</option>
                    <option value="2">Semana 2 (14 D√≠as)</option>
                    <option value="3">Semana 3 (21 D√≠as)</option>
                    <option value="4">Semana 4 (28 D√≠as)</option>
                    <option value="5">Semana 5 (35 D√≠as)</option>
                    <option value="6">Semana 6 (42 D√≠as)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="aves_pesadas">Cantidad de Aves Pesadas (Muestra):</label>
                <input type="number" id="aves_pesadas" min="1" required placeholder="Ej: 100">
            </div>

            <div class="input-group">
                <label for="peso_total">Peso Total de la Muestra (en gramos):</label>
                <input type="number" id="peso_total" min="1" required placeholder="Ej: 155000">
            </div>

            <div class="btn-group">
                <button id="btn-calcular" onclick="calcularCrecimiento()">Calcular Peso y Porcentaje</button>
                <button id="btn-guardar" onclick="generarPDFPeso()">üì• Guardar Reporte de Peso (PDF)</button>
            </div>

            <div id="resultados" style="display: none;">
                <h3>Resultados del Pesaje</h3>
                <div class="resultado-item">Galp√≥n Seleccionado: <span id="res_galpon"></span></div>
                <div class="resultado-item">Aves Vivas (Actual): <span id="res_aves_actuales"></span></div>
                <div class="resultado-item">Semana de Vida: <span id="res_semana"></span></div>
                <hr>
                <div class="resultado-item">Peso Promedio Real: <span id="promedio_real"></span> gramos</div>
                <div class="resultado-item">Diferencia con Est√°ndar: <span id="diferencia_gramos"></span> gramos</div>
                <div class="resultado-item">
                    <p><strong>Porcentaje de Subida/Baja de Peso:</strong> <span id="porcentaje_subida"></span></p>
                </div>
            </div>
        </div>

        <div id="mortalidad-section" class="content-section">
            <h2>3. Control de Mortalidad Semanal</h2>
            <p>Registre las p√©rdidas de la semana para actualizar el inventario y calcular el porcentaje de mortalidad.</p>

            <div class="input-group">
                <label for="galpon_mortalidad">Seleccionar Galp√≥n:</label>
                <select id="galpon_mortalidad" disabled>
                    <option value="" disabled selected>Primero configure los galpones (Secci√≥n 1)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="semana_mortalidad">Semana a Registrar (Semana de Vida):</label>
                <select id="semana_mortalidad">
                    <option value="1">Semana 1</option>
                    <option value="2">Semana 2</option>
                    <option value="3">Semana 3</option>
                    <option value="4">Semana 4</option>
                    <option value="5">Semana 5</option>
                    <option value="6">Semana 6</option>
                </select>
            </div>

            <div class="input-group">
                <label for="mortalidad_semanal">Aves Muertas en la Semana:</label>
                <input type="number" id="mortalidad_semanal" min="0" value="0" required placeholder="Ej: 50">
            </div>

            <div class="btn-group">
                <button id="btn-registrar-mortalidad" onclick="registrarMortalidad()">Registrar Mortalidad</button>
                <button id="btn-guardar-mortalidad" onclick="generarPDFMortalidad()" style="display: none; background-color: #dc3545; color: white;">üì• Guardar Reporte de Mortalidad (PDF)</button>
            </div>

            <div id="resultados_mortalidad" style="display: none;">
                <h3>Resultados de Mortalidad</h3>
                <div class="resultado-item">Galp√≥n: <span id="res_mort_galpon"></span></div>
                <div class="resultado-item">Aves Iniciales: <span id="res_mort_inicial"></span></div>
                <hr>
                <div class="resultado-item">P√©rdidas de la Semana: <span id="res_mort_semana_num"></span></div>
                <div class="resultado-item">Mortalidad Semanal: <span id="res_mort_porc_semanal" style="color: red;"></span></div>
                <div class="resultado-item">Mortalidad Acumulada (Total): <span id="res_mort_porc_acumulado" style="color: red;"></span></div>
                <hr>
                <div class="resultado-item"><strong>Aves Vivas Actuales:</strong> <span id="res_mort_actual" style="color: green;"></span></div>
            </div>
        </div>

        <div id="balanceado-section" class="content-section">
            <h2>4. Control de Consumo de Balanceado</h2>
            <p>Aqu√≠ registrar√°s el consumo diario o semanal de alimento.</p>
            
            <div class="input-group">
                <label for="galpon_balanceado">Seleccionar Galp√≥n:</label>
                <select id="galpon_balanceado" disabled>
                    <option value="" disabled selected>Primero configure los galpones (Secci√≥n 1)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="consumo_semanal">Consumo Total de la Semana (en kg):</label>
                <input type="number" id="consumo_semanal" min="0" required placeholder="Ej: 5000">
            </div>
            
            <div class="btn-group">
                <button style="background-color: #ffc107; color: black;">Calcular FCR (Conversi√≥n Alimenticia)</button> 
            </div>
        </div>

        <div id="reporte-section" class="content-section">
            <h2>5. Reportes de Granja</h2>
            <p>Genere un reporte completo con el resumen del estado actual de todos los galpones, incluyendo aves vivas y mortalidad acumulada.</p>
            <div class="btn-group" style="flex-direction: column; gap: 10px;">
                <button id="btn-reporte-completo" onclick="generarReporteCompletoPDF()">üìã Generar Reporte COMPLETO (PDF)</button>
            </div>
        </div>

    </div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // TABLA EST√ÅNDAR DE PESOS DE POLLOS DON JUAN (en gramos)
        const tablaEstandar = {
            1: 170, 2: 450, 3: 900, 4: 1550, 5: 2300, 6: 3050
        };

        // Variables globales de datos
        let farmName = "Granja Av√≠cola Pollos Don Juan"; 
        let galponesData = {}; 
        let datosCalculadosPeso = {};
        let datosCalculadosMortalidad = {};

        // --- FUNCIONES DE MEN√ö ---
        function showSection(sectionId, element) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            element.classList.add('active');
        }

        // --- FUNCIONES DE ALMACENAMIENTO ---

        function guardarDatosEnLocalStorage() {
            localStorage.setItem('farmName', farmName);
            localStorage.setItem('galponesData', JSON.stringify(galponesData));
        }

        function actualizarSelectoresGalpones() {
            const selectores = [
                document.getElementById('galpon'),
                document.getElementById('galpon_mortalidad'),
                document.getElementById('galpon_balanceado') 
            ];
            
            selectores.forEach(select => {
                select.innerHTML = ''; 
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = "Seleccione un galp√≥n";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                for (const galponID in galponesData) {
                    const avesActuales = galponesData[galponID].current.toLocaleString();
                    const option = document.createElement('option');
                    option.value = galponID;
                    option.textContent = `${galponID} (Actualmente: ${avesActuales} aves)`;
                    select.appendChild(option);
                }
                select.disabled = false;
            });
        }
        
        function cargarDatos() {
            const savedFarmName = localStorage.getItem('farmName');
            const savedGalponesData = localStorage.getItem('galponesData');

            if (savedFarmName) {
                farmName = savedFarmName;
                document.getElementById('farm_title').innerHTML = `üêî ${farmName} üìä`;
                document.getElementById('page_title').textContent = `${farmName} - Control de Producci√≥n`;
                document.getElementById('farm_name').value = farmName;
            }

            if (savedGalponesData) {
                galponesData = JSON.parse(savedGalponesData);
                
                const numGalpones = Object.keys(galponesData).length;
                document.getElementById('num_galpones').value = numGalpones;

                const tbody = document.getElementById('galpones-tbody');
                tbody.innerHTML = '';

                for (const galponID in galponesData) {
                    const i = galponID.replace('G', '');
                    const initialAves = galponesData[galponID].initial;
                    const row = `
                        <tr>
                            <td data-label="Galp√≥n (ID)">Galp√≥n ${i} (${galponID})</td>
                            <td data-label="Aves Iniciales"><input type="number" min="1" class="input-aves" id="aves_${galponID}" placeholder="Ej: 20000" value="${initialAves}" required></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }

                const totalAves = Object.values(galponesData).reduce((sum, data) => sum + data.initial, 0);
                document.getElementById('config-status').textContent = `‚úÖ Configuraci√≥n de ${farmName} cargada y guardada. Total de galpones: ${numGalpones}. Total de aves iniciales: ${totalAves.toLocaleString()}.`;
                document.getElementById('config-status').style.color = 'green';
                
                actualizarSelectoresGalpones(); 
                
            } else {
                generarCamposGalpones();
            }
        }

        document.addEventListener('DOMContentLoaded', cargarDatos);


        // --- FUNCIONES DE INTERFAZ Y L√ìGICA (Mismas funciones) ---

        function generarCamposGalpones() {
            const numGalpones = parseInt(document.getElementById('num_galpones').value);
            const tbody = document.getElementById('galpones-tbody');
            tbody.innerHTML = '';
            
            if (numGalpones < 1 || isNaN(numGalpones)) {
                tbody.innerHTML = '<tr><td colspan="2">Ingrese un n√∫mero v√°lido de galpones.</td></tr>';
                return;
            }

            for (let i = 1; i <= numGalpones; i++) {
                const galponID = `G${i}`;
                const row = `
                    <tr>
                        <td data-label="Galp√≥n (ID)">Galp√≥n ${i} (${galponID})</td>
                        <td data-label="Aves Iniciales"><input type="number" min="1" class="input-aves" id="aves_${galponID}" placeholder="Ej: 20000" required></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        }

        function guardarConfiguracion() {
            const newFarmName = document.getElementById('farm_name').value.trim();
            if (!newFarmName) {
                alert('Debe ingresar un nombre para la Granja.');
                return;
            }
            farmName = newFarmName;
            document.getElementById('farm_title').innerHTML = `üêî ${farmName} üìä`;
            document.getElementById('page_title').textContent = `${farmName} - Control de Producci√≥n`;


            const inputsAves = document.querySelectorAll('.input-aves');
            let tempGalponesData = {}; 
            let todoValido = true;
            let totalAves = 0;

            inputsAves.forEach(input => {
                const galponID = input.id.replace('aves_', '');
                const cantidadAves = parseInt(input.value);

                if (isNaN(cantidadAves) || cantidadAves <= 0) {
                    todoValido = false;
                    return;
                }
                
                const existingData = galponesData[galponID] || {
                    initial: 0,
                    current: 0,
                    mortalidadAcumulada: 0,
                    mortalidadHistory: {} 
                };

                if (existingData.initial !== cantidadAves) {
                    tempGalponesData[galponID] = {
                        initial: cantidadAves,
                        current: cantidadAves,
                        mortalidadAcumulada: 0,
                        mortalidadHistory: {}
                    };
                } else {
                    tempGalponesData[galponID] = existingData;
                }
                totalAves += tempGalponesData[galponID].initial;
            });

            if (!todoValido) {
                document.getElementById('config-status').textContent = '‚ö†Ô∏è ¬°Error! Ingrese una cantidad de aves v√°lida y mayor a cero para todos los galpones.';
                document.getElementById('config-status').style.color = 'red';
                return;
            }

            galponesData = tempGalponesData; 
            guardarDatosEnLocalStorage(); 
            actualizarSelectoresGalpones(); 

            document.getElementById('config-status').textContent = `‚úÖ Configuraci√≥n de ${farmName} guardada. Total de galpones: ${Object.keys(galponesData).length}. Total de aves iniciales: ${totalAves.toLocaleString()}.`;
            document.getElementById('config-status').style.color = 'green';
        }

        function registrarMortalidad() {
            const galpon = document.getElementById('galpon_mortalidad').value;
            const semana = parseInt(document.getElementById('semana_mortalidad').value);
            const mortalidad = parseInt(document.getElementById('mortalidad_semanal').value);

            if (!galpon || galponesData[galpon] === undefined) {
                alert('Debe seleccionar y guardar la configuraci√≥n de un galp√≥n.');
                return;
            }
            if (isNaN(mortalidad) || mortalidad < 0) {
                alert('La cantidad de aves muertas debe ser un n√∫mero positivo.');
                return;
            }
            
            const data = galponesData[galpon];
            
            const mortalidadPrevia = data.mortalidadHistory[semana] || 0;
            data.current += mortalidadPrevia;
            data.mortalidadAcumulada -= mortalidadPrevia;

            const avesAlInicioDeSemana = data.current; 
            if (mortalidad > avesAlInicioDeSemana) {
                alert('ERROR: La mortalidad registrada excede la cantidad de aves vivas actuales.');
                data.current -= mortalidadPrevia;
                data.mortalidadAcumulada += mortalidadPrevia;
                return;
            }

            data.current -= mortalidad;
            data.mortalidadAcumulada += mortalidad;
            data.mortalidadHistory[semana] = mortalidad;
            
            const mortSemanalPorc = (mortalidad / avesAlInicioDeSemana) * 100;
            const mortAcumuladaPorc = (data.mortalidadAcumulada / data.initial) * 100;

            // Almacenar para PDF (Incluye la cantidad acumulada de muertas)
            datosCalculadosMortalidad = {
                galpon,
                semana,
                inicial: data.initial.toLocaleString(),
                muertasSemana: mortalidad.toLocaleString(),
                muertasAcumuladas: data.mortalidadAcumulada.toLocaleString(), // Nuevo dato para la tabla
                actual: data.current.toLocaleString(),
                mortSemanal: mortSemanalPorc.toFixed(2),
                mortAcumulada: mortAcumuladaPorc.toFixed(2)
            };

            guardarDatosEnLocalStorage();
            actualizarSelectoresGalpones(); 
            
            document.getElementById('res_mort_galpon').textContent = galpon;
            document.getElementById('res_mort_inicial').textContent = datosCalculadosMortalidad.inicial;
            document.getElementById('res_mort_semana_num').textContent = datosCalculadosMortalidad.muertasSemana;
            document.getElementById('res_mort_porc_semanal').textContent = datosCalculadosMortalidad.mortSemanal + '%';
            document.getElementById('res_mort_porc_acumulado').textContent = datosCalculadosMortalidad.mortAcumulada + '%';
            document.getElementById('res_mort_actual').textContent = datosCalculadosMortalidad.actual;
            document.getElementById('resultados_mortalidad').style.display = 'block';
            document.getElementById('btn-guardar-mortalidad').style.display = 'inline-block';
        }

        function calcularCrecimiento() {
            const galpon = document.getElementById('galpon').value;
            const semana = parseInt(document.getElementById('semana').value);
            const avesPesadas = parseFloat(document.getElementById('aves_pesadas').value);
            const pesoTotal = parseFloat(document.getElementById('peso_total').value);

            if (!galpon || galponesData[galpon] === undefined) {
                alert('Debe seleccionar y guardar la configuraci√≥n de un galp√≥n.');
                return;
            }
            if (isNaN(avesPesadas) || avesPesadas <= 0 || isNaN(pesoTotal) || pesoTotal <= 0) {
                alert('Por favor, ingrese valores v√°lidos y mayores a cero en los campos de pesaje.');
                return;
            }
            
            const data = galponesData[galpon];
            const pesoPromedioReal = pesoTotal / avesPesadas;
            const pesoEstandar = tablaEstandar[semana];

            if (!pesoEstandar) {
                alert('No hay un peso est√°ndar definido para esta semana.');
                return;
            }

            const diferenciaGramos = pesoPromedioReal - pesoEstandar;
            const porcentajeSubida = (diferenciaGramos / pesoEstandar) * 100;

            // Almacenar resultados para PDF
            datosCalculadosPeso = {
                galpon,
                avesActuales: data.current.toLocaleString(),
                semana: semana,
                promedioReal: pesoPromedioReal.toFixed(2),
                estandar: pesoEstandar.toFixed(2),
                diferencia: diferenciaGramos.toFixed(2),
                porcentaje: porcentajeSubida.toFixed(2)
            };
            
            document.getElementById('res_galpon').textContent = galpon;
            document.getElementById('res_aves_actuales').textContent = datosCalculadosPeso.avesActuales;
            document.getElementById('res_semana').textContent = datosCalculadosPeso.semana;
            document.getElementById('promedio_real').textContent = datosCalculadosPeso.promedioReal;
            document.getElementById('diferencia_gramos').textContent = datosCalculadosPeso.diferencia;
            
            const porcentajeElement = document.getElementById('porcentaje_subida');
            porcentajeElement.textContent = datosCalculadosPeso.porcentaje + '%';

            if (porcentajeSubida >= 0) {
                porcentajeElement.style.color = 'green';
                porcentajeElement.textContent = '+' + porcentajeElement.textContent;
            } else {
                porcentajeElement.style.color = 'red';
            }

            document.getElementById('resultados').style.display = 'block';
            document.getElementById('btn-guardar').style.display = 'inline-block';
        }

        // 5. L√≥gica para Generar PDF de Peso (USANDO AUTO TABLE)
        function generarPDFPeso() {
            if (Object.keys(datosCalculadosPeso).length === 0) {
                alert('Primero debe realizar un c√°lculo de peso.');
                return;
            }

            const data = datosCalculadosPeso;
            const doc = new jsPDF();
            const margen = 15;
            let linea = 15;

            doc.setFontSize(16);
            doc.text(`Reporte de Pesaje - ${farmName}`, margen, linea);
            linea += 7;
            doc.setFontSize(10);
            doc.text(`Fecha del Reporte: ${new Date().toLocaleDateString()}`, margen, linea);
            linea += 10;
            
            // Datos para la tabla de Lote
            const head = [['M√©trica', 'Galp√≥n', 'Semana', 'Aves Vivas']];
            const body = [
                ['Datos de Lote', data.galpon, data.semana, data.avesActuales]
            ];
            
            doc.autoTable({
                startY: linea,
                head: head,
                body: body,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [63, 81, 181] } // Azul
            });
            linea = doc.autoTable.previous.finalY + 10;
            
            // Datos para la tabla de resultados
            const headResultados = [['M√©trica de Peso', 'Valor (gramos)', 'Diferencia', 'Crecimiento vs. Est√°ndar']];
            const bodyResultados = [
                ['Peso Promedio Real', data.promedioReal, data.diferencia, data.porcentaje + '%'],
                ['Peso Est√°ndar Don Juan', data.estandar, '', '']
            ];

            doc.autoTable({
                startY: linea,
                head: headResultados,
                body: bodyResultados,
                theme: 'striped',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [251, 192, 45], textColor: [0, 0, 0] }, // Amarillo
                columnStyles: {
                    2: { fontStyle: 'bold', textColor: data.diferencia >= 0 ? [0, 128, 0] : [255, 0, 0] }, 
                    3: { fontStyle: 'bold', textColor: data.porcentaje >= 0 ? [0, 128, 0] : [255, 0, 0] } 
                }
            });

            const nombreArchivo = `Reporte_Pesaje_${data.galpon}_Semana_${data.semana}.pdf`;
            doc.save(nombreArchivo);
        }

        // 6. L√≥gica para Generar PDF de Mortalidad (USANDO AUTO TABLE)
        function generarPDFMortalidad() {
            if (Object.keys(datosCalculadosMortalidad).length === 0) {
                alert('Primero debe registrar la mortalidad.');
                return;
            }

            const data = datosCalculadosMortalidad;
            const doc = new jsPDF();
            const margen = 15;
            let linea = 15;

            doc.setFontSize(16);
            doc.text(`Reporte de Mortalidad Semanal - ${farmName}`, margen, linea); 
            linea += 7;
            doc.setFontSize(10);
            doc.text(`Fecha del Registro: ${new Date().toLocaleDateString()}`, margen, linea);
            linea += 10;

            // Datos para la tabla de Lote
            const headLote = [['Galp√≥n', 'Semana Registrada', 'Aves Iniciales']];
            const bodyLote = [
                [data.galpon, data.semana, data.inicial]
            ];

            doc.autoTable({
                startY: linea,
                head: headLote,
                body: bodyLote,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [220, 53, 69] } // Rojo
            });
            linea = doc.autoTable.previous.finalY + 10;

            // Datos para la tabla de Resultados
            const headResultados = [['M√©trica', 'Cantidad', 'Porcentaje']];
            const bodyResultadosFinal = [
                ['P√©rdidas de la Semana', data.muertasSemana, {content: data.mortSemanal + '%', styles: {textColor: [255, 0, 0]}}],
                ['Mortalidad Acumulada Total', data.muertasAcumuladas, {content: data.mortAcumulada + '%', styles: {textColor: [255, 0, 0]}}],
                [{content: 'AVES VIVAS ACTUALES', colSpan: 2, styles: {fillColor: [165, 214, 167], fontStyle: 'bold', textColor: [0, 0, 0]}}, {content: data.actual, styles: {fillColor: [165, 214, 167], fontStyle: 'bold', textColor: [0, 0, 0]}}]
            ];

            doc.autoTable({
                startY: linea,
                head: headResultados,
                body: bodyResultadosFinal,
                theme: 'striped',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [248, 249, 250], textColor: [0, 0, 0] },
            });

            const nombreArchivo = `Reporte_Mortalidad_${data.galpon}_Semana_${data.semana}.pdf`;
            doc.save(nombreArchivo);
        }

        // 7. Funci√≥n para generar el Reporte COMPLETO de la Granja (USANDO AUTO TABLE)
        function generarReporteCompletoPDF() {
            if (Object.keys(galponesData).length === 0) {
                alert('Primero debe configurar y guardar la informaci√≥n de al menos un galp√≥n.');
                return;
            }

            const doc = new jsPDF();
            const margen = 15;
            let linea = 15;

            // --- ENCABEZADO PRINCIPAL ---
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(`REPORTE DE PRODUCCI√ìN COMPLETO - ${farmName}`, margen, linea);
            linea += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Fecha de Generaci√≥n: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, margen, linea);
            linea += 10;

            // --- RESUMEN POR GALP√ìN ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN DE ESTADO DE GALPONES:', margen, linea);
            
            const headGalpones = [
                ['Galp√≥n', 'Aves Iniciales', 'Mortalidad Acum.', 'Mortalidad %', 'Aves Vivas Actuales']
            ];
            
            const bodyGalpones = [];

            for (const galponID in galponesData) {
                const data = galponesData[galponID];
                const mortPorc = (data.mortalidadAcumulada / data.initial) * 100;
                
                const historiaMort = Object.entries(data.mortalidadHistory)
                                            .map(([semana, muertas]) => `S${semana}: ${muertas.toLocaleString()}`)
                                            .join(' | ');

                bodyGalpones.push([
                    galponID,
                    data.initial.toLocaleString(),
                    data.mortalidadAcumulada.toLocaleString(),
                    {content: `${mortPorc.toFixed(2)}%`, styles: {textColor: [255, 0, 0]}},
                    {content: data.current.toLocaleString(), styles: {fontStyle: 'bold', textColor: [0, 128, 0]}} 
                ]);
                
                bodyGalpones.push([
                    { content: `Historial Semanal: ${historiaMort || '(No hay registros)'}`, colSpan: 5, styles: { fontStyle: 'italic', fontSize: 8, fillColor: [240, 240, 240] } }
                ]);
            }

            doc.autoTable({
                startY: linea + 5,
                head: headGalpones,
                body: bodyGalpones,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [56, 142, 60] } // Verde av√≠cola
            });
            linea = doc.autoTable.previous.finalY + 10;

            // --- RESUMEN DE √öLTIMOS C√ÅLCULOS ESPEC√çFICOS ---
            if (linea > 260) {
                doc.addPage();
                linea = 15;
            }

            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('RESUMEN DE √öLTIMOS C√ÅLCULOS (Referenciales):', margen, linea);
            
            const headCalculos = [
                ['Reporte', 'Galp√≥n', 'Semana', 'M√©trica 1', 'M√©trica 2']
            ];
            const bodyCalculos = [];

            if (Object.keys(datosCalculadosPeso).length > 0) {
                bodyCalculos.push([
                    {content: '√öLTIMO PESO', styles: {fontStyle: 'bold'}},
                    datosCalculadosPeso.galpon,
                    datosCalculadosPeso.semana,
                    `P. Real: ${datosCalculadosPeso.promedioReal}g`,
                    `vs. Est√°ndar: ${datosCalculadosPeso.porcentaje}%`
                ]);
            } else {
                bodyCalculos.push([
                    {content: '√öLTIMO PESO', styles: {fontStyle: 'bold'}},
                    {content: 'No hay c√°lculo de peso reciente guardado.', colSpan: 4, styles: {fontStyle: 'italic'}}
                ]);
            }

            if (Object.keys(datosCalculadosMortalidad).length > 0) {
                bodyCalculos.push([
                    {content: '√öLTIMA MORTALIDAD', styles: {fontStyle: 'bold'}},
                    datosCalculadosMortalidad.galpon,
                    datosCalculadosMortalidad.semana,
                    `Semanal: ${datosCalculadosMortalidad.mortSemanal}%`,
                    `Acumulada: ${datosCalculadosMortalidad.mortAcumulada}%`
                ]);
            } else {
                bodyCalculos.push([
                    {content: '√öLTIMA MORTALIDAD', styles: {fontStyle: 'bold'}},
                    {content: 'No hay registro de mortalidad reciente guardado.', colSpan: 4, styles: {fontStyle: 'italic'}}
                ]);
            }

            doc.autoTable({
                startY: linea + 5,
                head: headCalculos,
                body: bodyCalculos,
                theme: 'striped',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [150, 150, 150] }
            });

            const nombreArchivo = `Reporte_Completo_${farmName.replace(/ /g, '_')}_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`;
            doc.save(nombreArchivo);
        }
    </script>

</body>
</html>
